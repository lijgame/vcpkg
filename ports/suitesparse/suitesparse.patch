From 5db372cf5a0a1597f3b0feb81f1b199da4cfed50 Mon Sep 17 00:00:00 2001
From: Jack Li <Jack.li@autodesk.com>
Date: Thu, 20 Feb 2020 12:10:28 +0800
Subject: [PATCH] suitesparse.patch

---
 CMakeLists.txt                             | 8 ++++----
 SuiteSparse/CHOLMOD/Include/cholmod_blas.h | 1 +
 SuiteSparse/CMakeLists.txt                 | 6 +++---
 cmake/SuiteSparse-config-install.cmake.in  | 6 +++++-
 4 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 8d905b7..3b3f436 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -228,8 +228,8 @@ if (LAPACK_FOUND AND TARGET blas AND TARGET lapack)
   set(SuiteSparse_LAPACK_used_CONFIG YES)
 else()
   # missing config file or targets, try BLAS and LAPACK
-  find_package(BLAS)
-  find_package(LAPACK)
+  find_package(BLAS REQUIRED)
+  find_package(LAPACK REQUIRED)
   if (BLAS_FOUND AND LAPACK_FOUND)
     message(STATUS "found lapack and blas config file. Linking targets lapack and blas")
     message(STATUS "- LAPACK_LIBRARIES: ${LAPACK_LIBRARIES}")
@@ -242,7 +242,7 @@ else()
   endif()
 endif()
 
-IF(BUILD_METIS)
+IF(BUILD_METIS OR USE_VCPKG_METIS)
 	set(SuiteSparse_LINKER_METIS_LIBS "metis")
 	## namespaced library target for config
 	set(SuiteSparse_EXPORTED_METIS_LIBS "SuiteSparse::metis")
@@ -301,7 +301,7 @@ configure_file(cmake/SuiteSparse-config-install.cmake.in
 ## do the EXPORT for allowing other project to easily use suitesparse with cmake
 install(EXPORT SuiteSparseTargets
 	FILE
-		SuiteSparse-targets.cmake
+		suitesparse-targets.cmake
 	NAMESPACE
 		SuiteSparse::
 	DESTINATION
diff --git a/SuiteSparse/CHOLMOD/Include/cholmod_blas.h b/SuiteSparse/CHOLMOD/Include/cholmod_blas.h
index aef3e63..907512b 100644
--- a/SuiteSparse/CHOLMOD/Include/cholmod_blas.h
+++ b/SuiteSparse/CHOLMOD/Include/cholmod_blas.h
@@ -27,6 +27,7 @@
 #elif defined (__linux) || defined (MGLNX86) || defined (ARCH_GLNX86)
 #define CHOLMOD_LINUX
 #define CHOLMOD_ARCHITECTURE "Linux"
+#define BLAS_NO_UNDERSCORE
 
 #elif defined (__APPLE__)
 #define CHOLMOD_MAC
diff --git a/SuiteSparse/CMakeLists.txt b/SuiteSparse/CMakeLists.txt
index c6e2834..5ef08a6 100644
--- a/SuiteSparse/CMakeLists.txt
+++ b/SuiteSparse/CMakeLists.txt
@@ -12,11 +12,11 @@ IF(CMAKE_COMPILER_IS_GNUCXX AND NOT CMAKE_BUILD_TYPE MATCHES "Debug")
 ENDIF(CMAKE_COMPILER_IS_GNUCXX AND NOT CMAKE_BUILD_TYPE MATCHES "Debug")
 
 # Global flags:
-IF (BUILD_METIS)
+IF (BUILD_METIS OR USE_VCPKG_METIS)
 	INCLUDE_DIRECTORIES("${METIS_SOURCE_DIR}/include")
-ELSE (BUILD_METIS)
+ELSE ()
 	ADD_DEFINITIONS(-DNPARTITION)
-ENDIF ( BUILD_METIS)
+ENDIF ()
 
 # Disable COMPLEX numbers: disable it by default, since it causes problems in some platforms.
 SET(HAVE_COMPLEX OFF CACHE BOOL "Enables building SuiteSparse with complex numbers (disabled by default to avoid problems in some platforms)")
diff --git a/cmake/SuiteSparse-config-install.cmake.in b/cmake/SuiteSparse-config-install.cmake.in
index 1e587d1..4e59b1f 100644
--- a/cmake/SuiteSparse-config-install.cmake.in
+++ b/cmake/SuiteSparse-config-install.cmake.in
@@ -15,7 +15,7 @@ else()
 endif ()
 
 # Load targets from the install tree.
-include(${_SuiteSparse_SELF_DIR}/SuiteSparse-targets.cmake)
+include(${_SuiteSparse_SELF_DIR}/suitesparse-targets.cmake)
 
 # Report SuiteSparse header search locations.
 set(SuiteSparse_INCLUDE_DIRS ${_SuiteSparse_PREFIX}/include)
@@ -36,6 +36,10 @@ set(SuiteSparse_LIBRARIES
 	SuiteSparse::spqr
 	@SuiteSparse_EXPORTED_METIS_LIBS@
 )
+set(SUITESPARSE_LIBRARIES ${SuiteSparse_LIBRARIES})
 
 unset(_SuiteSparse_PREFIX)
 unset(_SuiteSparse_SELF_DIR)
+
+set(SUITESPARSE_FOUND TRUE)
+set(SuiteSparse_FOUND TRUE)
\ No newline at end of file
-- 
2.21.0.windows.1

